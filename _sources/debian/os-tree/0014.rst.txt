==========================
Ostree systemd generator
==========================


Ostree provide a systemd generator named **ostree-system-generator** which

is responsible for creating **var.mount** and enabling the ostree's systemd services.

src/switchroot/ostree-system-generator.c:

.. code-block::

   ...
   {
      g_autoptr (GError) local_error = NULL;
      if (!ostree_cmd__private__ ()->ostree_system_generator (arg_dest, NULL, arg_dest_late,
                                                             &local_error))
         errx (EXIT_FAILURE, "%s", local_error->message);
   }




ostree_cmd__private__ is a struct which was implemented at **src/libostree/ostree-cmd-private.c**

.. code-block::

   const OstreeCmdPrivateVTable *
   ostree_cmd__private__ (void)
   {
     static OstreeCmdPrivateVTable table = {
       _ostree_impl_system_generator,    impl_ostree_generate_grub2_config,
       _ostree_repo_static_delta_dump,   _ostree_repo_static_delta_query_exists,
       _ostree_repo_static_delta_delete, _ostree_repo_verify_bindings,
       _ostree_sysroot_finalize_staged,  _ostree_sysroot_boot_complete,
     };
     return &table;
   }


**_ostree_impl_system_generator,** is the main function for systemd generator.

**src/libostree/ostree-impl-system-generator.c**:


.. code-block::

      if (!require_internal_units (normal_dir, early_dir, late_dir, error))
        return FALSE;
      if (!fstab_generator (ostree_target, is_aboot, normal_dir, early_dir, late_dir, error))
        return FALSE;


**require_internal_units**: Forcibly enable our internal units, since we detected ostree= on the kernel cmdline.

.. code-block::

   ...
   if (!glnx_shutil_mkdir_p_at (normal_dir_dfd, "local-fs.target.requires", 0755, cancellable,
                                error))
     return FALSE;
   if (symlinkat (SYSTEM_DATA_UNIT_PATH "/ostree-remount.service", normal_dir_dfd,
                  "local-fs.target.requires/ostree-remount.service")
       < 0)
     return glnx_throw_errno_prefix (error, "symlinkat");
   if (!glnx_shutil_mkdir_p_at (normal_dir_dfd, "multi-user.target.wants", 0755, cancellable, error))
     return FALSE;
   if (symlinkat (SYSTEM_DATA_UNIT_PATH "/ostree-finalize-staged.path", normal_dir_dfd,
                  "multi-user.target.wants/ostree-finalize-staged.path")
       < 0)
     return glnx_throw_errno_prefix (error, "symlinkat");
   if (symlinkat (SYSTEM_DATA_UNIT_PATH "/ostree-boot-complete.service", normal_dir_dfd,
                  "multi-user.target.wants/ostree-boot-complete.service")
   ...

**fstab_generator**: Generate var.mount


.. code-block::

    /* Generate var.mount */
    static gboolean
    fstab_generator (const char *ostree_target, const bool is_aboot, const char *normal_dir,
                     const char *early_dir, const char *late_dir, GError **error)
    {
    ...
    ...

    /* Generate our bind mount unit */
      const char *stateroot_var_path = glnx_strjoina ("/sysroot/ostree/deploy/", stateroot, "/var");

    ...
    ...

      if (!g_output_stream_printf (outstream, &bytes_written, cancellable, error,
                                   "##\n# Automatically generated by ostree-system-generator\n##\n\n"
                                   "[Unit]\n"
                                   "Documentation=man:ostree(1)\n"
                                   "ConditionKernelCommandLine=!systemd.volatile\n"
                                   "Before=local-fs.target\n"
                                   "\n"
                                   "[Mount]\n"
                                   "Where=%s\n"
                                   "What=%s\n"
                                   "Options=bind,slave,shared\n",
                                   var_path, stateroot_var_path))
    ...
    ...

      if (!glnx_shutil_mkdir_p_at (normal_dir_dfd, "local-fs.target.requires", 0755, cancellable,
                                error))
        return FALSE;
      if (symlinkat ("../var.mount", normal_dir_dfd, "local-fs.target.requires/var.mount") < 0)
        return glnx_throw_errno_prefix (error, "symlinkat");


The output:

.. code-block::

   root@localhost:~# ls /run/systemd/generator/local-fs.target.requires/var.mount -lh
   lrwxrwxrwx 1 root root 12 Mar  6 14:56 /run/systemd/generator/local-fs.target.requires/var.mount -> ../var.mount
   root@localhost:~# cat /run/systemd/generator/var.mount
   ##
   # Automatically generated by ostree-system-generator
   ##

   [Unit]
   Documentation=man:ostree(1)
   ConditionKernelCommandLine=!systemd.volatile
   Before=local-fs.target

   [Mount]
   Where=/var
   What=/sysroot/ostree/deploy/elxr/var
   Options=bind,slave,shared
   root@localhost:~#
